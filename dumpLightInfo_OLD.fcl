#include "services_common_icarus.fcl"
#include "channelmapping_icarus.fcl"
#include "decoderdefs_icarus.fcl"
#include "icarus_ophitfinder.fcl"
#include "icarus_flashfinder.fcl"
#include "icarus_opana_modules.fcl"
#include "timing_icarus.fcl"

#include "rootoutput_icarus.fcl"

process_name: dumpLight


icarus_V1730_16thChannel_trgprim_setup_Adders: {
  ChannelIndex:          15  # the last one
  Channel:             @nil  # needs to be customized on each board
  OnlyOnGlobalTrigger: false
  InstanceName:          "trgprim"
}
icarus_V1730_16thChannel_BNBbeam_setup_Adders: {
  ChannelIndex:          15  # the last one
  Channel:             @nil  # needs to be customized on each board
  MinSpan:             10   # needs to span at least 100 ADC peak-to-peak
  OnlyOnGlobalTrigger: false
  InstanceName:          "BNB"
}
icarus_V1730_16thChannel_NuMIbeam_setup_Adders: {
  ChannelIndex:          15  # the last one
  Channel:             @nil  # needs to be customized on each board
  MinSpan:              10  # needs to span at least 100 ADC peak-to-peak
  OnlyOnGlobalTrigger: false
  InstanceName:          "NuMI"
}

icarus_V1730_West_setup_Adders: [

  ### --------------------------------------------------------------------------
  ###  WW
  ### --------------------------------------------------------------------------
  #
  # top
  #
  { Name: "icaruspmtwwtop01"  TriggerDelay: " 0 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_trgprim_setup_Adders   Channel: 0x1071 } ] },
  { Name: "icaruspmtwwtop02"  TriggerDelay: "43 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_BNBbeam_setup_Adders   Channel: 0x4072 } ] },
  { Name: "icaruspmtwwtop03"  TriggerDelay: "86 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_NuMIbeam_setup_Adders  Channel: 0x5073 } ] },
  #
  # bottom
  #
  { Name: "icaruspmtwwbot01"  TriggerDelay: " 0 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_trgprim_setup_Adders   Channel: 0x1061 } ] },
  { Name: "icaruspmtwwbot02"  TriggerDelay: "43 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_BNBbeam_setup_Adders   Channel: 0x4062 } ] },
  { Name: "icaruspmtwwbot03"  TriggerDelay: "86 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_NuMIbeam_setup_Adders  Channel: 0x5063 } ] },
  ### --------------------------------------------------------------------------
  ### WE
  ### --------------------------------------------------------------------------
  #
  # top
  #
  { Name: "icaruspmtwetop01"  TriggerDelay: " 0 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_trgprim_setup_Adders   Channel: 0x1051 } ] },
  { Name: "icaruspmtwetop02"  TriggerDelay: "43 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_BNBbeam_setup_Adders   Channel: 0x4052 } ] },
  { Name: "icaruspmtwetop03"  TriggerDelay: "86 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_NuMIbeam_setup_Adders  Channel: 0x5053 } ] },
  #
  # bottom
  #
  { Name: "icaruspmtwebot01"  TriggerDelay: " 0 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_trgprim_setup_Adders   Channel: 0x1041 } ] },
  { Name: "icaruspmtwebot02"  TriggerDelay: "43 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_BNBbeam_setup_Adders   Channel: 0x4042 } ] },
  { Name: "icaruspmtwebot03"  TriggerDelay: "86 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_NuMIbeam_setup_Adders  Channel: 0x5043 } ] }
  ### --------------------------------------------------------------------------

] # icarus_V1730_West_setup_Adders

icarus_V1730_East_setup_Adders: [
  ### --------------------------------------------------------------------------
  ### EW
  ### --------------------------------------------------------------------------
  #
  # top
  #
  { Name: "icaruspmtewtop01"  TriggerDelay: " 0 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_trgprim_setup_Adders   Channel: 0x1031 } ] },
  { Name: "icaruspmtewtop02"  TriggerDelay: "43 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_BNBbeam_setup_Adders   Channel: 0x4032 } ] },
  { Name: "icaruspmtewtop03"  TriggerDelay: "86 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_NuMIbeam_setup_Adders  Channel: 0x5033 } ] },
  #
  # bottom
  #
  { Name: "icaruspmtewbot01"  TriggerDelay: " 0 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_trgprim_setup_Adders   Channel: 0x1021 } ] },
  { Name: "icaruspmtewbot02"  TriggerDelay: "43 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_BNBbeam_setup_Adders   Channel: 0x4022 } ] },
  { Name: "icaruspmtewbot03"  TriggerDelay: "86 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_NuMIbeam_setup_Adders  Channel: 0x5023 } ] },
  ### --------------------------------------------------------------------------
  ### EE
  ### --------------------------------------------------------------------------
  #
  # top
  #
  { Name: "icaruspmteetop01"  TriggerDelay: " 0 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_trgprim_setup_Adders   Channel: 0x1011 } ] },
  { Name: "icaruspmteetop02"  TriggerDelay: "43 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_BNBbeam_setup_Adders   Channel: 0x4012 } ] },
  { Name: "icaruspmteetop03"  TriggerDelay: "86 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_NuMIbeam_setup_Adders  Channel: 0x5013 } ] },
  #
  # bottom
  #
  { Name: "icaruspmteebot01"  TriggerDelay: " 0 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_trgprim_setup_Adders   Channel: 0x1001 } ] },
  { Name: "icaruspmteebot02"  TriggerDelay: "43 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_BNBbeam_setup_Adders   Channel: 0x4002 } ] },
  { Name: "icaruspmteebot03"  TriggerDelay: "86 ns"  SpecialChannels: [ { @table::icarus_V1730_16thChannel_NuMIbeam_setup_Adders  Channel: 0x5003 } ] }
  ### --------------------------------------------------------------------------
  
] # icarus_V1730_East_setup_Adders

icarus_V1730_setup_Adders: [
  
  @sequence::icarus_V1730_West_setup_Adders,
  @sequence::icarus_V1730_East_setup_Adders
  
] # icarus_V1730_setup_Adders


services:
{
   TFileService: { fileName: "ana.root" }
   @table::icarus_geometry_services
   @table::icarus_basic_services
   IICARUSChannelMap: @local::icarus_channelmappinggservice
   PMTTimingCorrections: @local::icarus_pmttimingservice
}

#Look at the input files
source:
{
  module_type: RootInput
  fileNames:  [ "data.root" ]
  maxEvents:   -1       # Number of events to create
}

# Make sure to get rid of NuRandomSvc (not thread save)
services.NuRandomService: @erase

physics:
{

    // now also have something produce the digits and headers
    producers:
    {

        triggerconfig: @local::extractTriggerConfig
        
	PMTconfig: @local::extractPMTconfig 

	      daqTrigger: @local::decodeTriggerV2

        daqPMT: @local::decodePMT

        ophit: @local::icarus_ophit_data

    }

    my_producer_modules: [ triggerconfig, PMTconfig, daqTrigger, daqPMT, ophit ]

    trigger_paths: [ my_producer_modules ]
    end_paths: []
}



## Parameters override ####################################################

# Output file 
# 

# customization of Trigger decoding 
# 
physics.producers.daqTrigger.DecoderTool.DiagnosticOutput: false
physics.producers.daqTrigger.DecoderTool.Debug: false

# customization of PMT decoding
#
physics.producers.daqTrigger.DecoderTool.TrigConfigLabel: triggerconfig
physics.producers.daqPMT.PMTconfigTag: PMTconfig # required
physics.producers.daqPMT.TriggerTag:   daqTrigger # required
physics.producers.daqPMT.SurviveExceptions: true
physics.producers.daqPMT.DiagnosticOutput:  true
physics.producers.daqPMT.PacketDump:        false
physics.producers.daqPMT.RequireKnownBoards: false
physics.producers.daqPMT.RequireBoardConfig: false
physisc.producers.daqPMT.BoardSetup: @local::icarus_V1730_setup_Adders


# Customization of the OpHit reconstruction module
#
physics.producers.ophit.module_type: "FullOpHitFinder" 
physics.producers.ophit.InputModule: "daqPMT"
physics.producers.ophit.InputLabels: ["", "trgprim", "BNB", "NuMI"]
physics.producers.ophit.OutputFile: "dumpLightFileRun.root"


# Pedestal configuration
#
physics.producers.ophit.PedAlgoPset.Name: "RollingMean"
physics.producers.ophit.PedAlgoPset.SampleSize:  20
physics.producers.ophit.PedAlgoPset.Threshold:   1.5
physics.producers.ophit.PedAlgoPset.MaxSigma:    5
physics.producers.ophit.PedAlgoPset.PedRangeMax: 25000
physics.producers.ophit.PedAlgoPset.PedRangeMin: 0
physics.producers.ophit.PedAlgoPset.DiffADCCounts: 2
physics.producers.ophit.PedAlgoPset.DiffBetweenGapsThreshold: 2
physics.producers.ophit.PedAlgoPset.Verbosity: true

# OpHit configuration
#
physics.producers.ophit.HitAlgoPset.ADCThreshold: 10
physics.producers.ophit.HitAlgoPset.EndADCThreshold: 2
physics.producers.ophit.HitAlgoPset.EndNSigmaThreshold: 1
physics.producers.ophit.HitAlgoPset.MinPulseWidth: 5
physics.producers.ophit.HitAlgoPset.NSigmaThreshold: 3
physics.producers.ophit.HitAlgoPset.Name: "SlidingWindow"
physics.producers.ophit.HitAlgoPset.NumPostSample: 10
physics.producers.ophit.HitAlgoPset.NumPreSample: 5
physics.producers.ophit.HitAlgoPset.PositivePolarity: false
physics.producers.ophit.HitAlgoPset.TailADCThreshold: 6
physics.producers.ophit.HitAlgoPset.TailNSigmaThreshold: 2
physics.producers.ophit.HitAlgoPset.Verbosity: false
physics.producers.ophit.AreaToPE: true
physics.producers.ophit.ChannelMasks: []
physics.producers.ophit.SPEArea: 157
physics.producers.ophit.SPEShift: 0
physics.producers.ophit.UseStartTime: true
